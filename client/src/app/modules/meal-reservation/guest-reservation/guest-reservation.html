<div class="flex flex-col h-full bg-background overflow-y-auto overflow-x-hidden animate-fade-in">
    
    <div class="flex flex-col gap-6 p-4 md:p-6 pb-32">

        <div class="flex items-center gap-3 px-1">
            <div class="p-2.5 bg-dark text-white rounded-xl shadow-md shadow-dark/20">
                <icon name="users" className="w-6 h-6"></icon>
            </div>
            <div>
                <h2 class="text-xl font-bold text-text-main">رزرو غذای میهمان</h2>
                <p class="text-xs text-text-muted mt-1">مشخصات میهمان و بازه اقامت را وارد کنید</p>
            </div>
        </div>

        <form [formGroup]="entityForm" (ngSubmit)="generateGuestCalendar()" 
              class="bg-surface border border-border/60 rounded-2xl p-5 shadow-sm">
            
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-5 items-end">
                
                <div class="flex flex-col gap-1.5 w-full">
                    <label class="text-xs font-bold text-text-main pr-1">نام میهمان</label>
                    <div class="relative flex items-center h-11 bg-background border border-border rounded-xl focus-within:border-primary focus-within:ring-1 focus-within:ring-primary/20 transition-all overflow-hidden px-3"
                         [class.border-red-500]="entityForm.get('fullName')?.touched && entityForm.get('fullName')?.invalid">
                        <icon name="user" className="w-5 h-5 text-text-muted shrink-0 ml-2"></icon>
                        <input type="text" formControlName="fullName" placeholder="مثال: رضا علوی" class="w-full h-full bg-transparent border-none outline-none text-sm text-text-main placeholder-text-muted/50">
                    </div>
                    <div class="h-4 flex items-center pr-1">
                        @if (entityForm.get('fullName')?.touched && entityForm.get('fullName')?.invalid) {
                            <span class="text-[10px] text-red-500 animate-fade-in flex items-center gap-1">
                                <icon name="exclamation-circle" className="w-3 h-3"></icon>
                                {{ validationMessages?.fullName?.required }}
                            </span>
                        }
                    </div>
                </div>

                <div class="flex flex-col gap-1.5 w-full">
                    <label class="text-xs font-bold text-text-main pr-1">تعداد نفرات</label>
                    <div class="relative flex items-center h-11 bg-background border border-border rounded-xl px-3 shadow-sm">
                        <icon name="users" className="w-5 h-5 text-text-muted shrink-0 ml-2"></icon>
                        <input type="number" formControlName="guestCount" placeholder="تعداد" min="1" class="w-full h-full bg-transparent border-none outline-none text-sm text-text-main placeholder-text-muted/50 tabular-nums">
                    </div>
                    <div class="h-4"></div> </div>

                <div class="flex flex-col gap-1.5 w-full">
                    <app-persian-date-picker 
                        formControlName="checkIn" 
                        label="تاریخ ورود"
                        placeholder="انتخاب تاریخ">
                    </app-persian-date-picker>
                    <div class="h-4 flex items-center pr-1">
                        @if (entityForm.get('checkIn')?.touched && entityForm.get('checkIn')?.invalid) {
                            <span class="text-[10px] text-red-500 animate-fade-in flex items-center gap-1">
                                <icon name="exclamation-circle" className="w-3 h-3"></icon>
                                {{ validationMessages?.checkIn?.required }}
                            </span>
                        }
                    </div>
                </div>

                <div class="flex flex-col gap-1.5 w-full">
                    <app-persian-date-picker 
                        formControlName="checkOut" 
                        label="تاریخ خروج"
                        placeholder="انتخاب تاریخ">
                    </app-persian-date-picker>
                    <div class="h-4 flex items-center pr-1">
                        @if (entityForm.get('checkOut')?.touched && entityForm.get('checkOut')?.invalid) {
                            <span class="text-[10px] text-red-500 animate-fade-in flex items-center gap-1">
                                <icon name="exclamation-circle" className="w-3 h-3"></icon>
                                {{ validationMessages?.checkOut?.required }}
                            </span>
                        }
                    </div>
                </div>

            </div>

            <div class="mt-4 flex justify-end pt-4 border-t border-border/30">
                <button type="submit" 
                        class="h-11 px-8 bg-primary hover:bg-primary-hover text-white font-bold text-sm rounded-xl shadow-lg shadow-primary/25 active:scale-95 transition-all flex items-center gap-2 w-full md:w-auto justify-center cursor-pointer">
                    <span>نمایش روزها و انتخاب غذا</span>
                    <icon name="arrow-left" className="w-4 h-4"></icon>
                </button>
            </div>
        </form>

        @if (showCalendar && guestDays.length > 0) {
            <div class="flex flex-col gap-3 animate-slide-up">
                <div class="flex items-center gap-2 mb-1 pr-1">
                    <div class="h-1.5 w-1.5 rounded-full bg-primary"></div>
                    <h3 class="text-sm font-bold text-text-main">برنامه اقامت ({{ guestDays.length }} روز)</h3>
                </div>

                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-7 gap-3">
                    @for (day of guestDays; track day.dateIso) {
                        <div (click)="onSelectDay(day)"
                             class="group relative flex flex-col h-32 rounded-2xl border transition-all duration-300 cursor-pointer overflow-hidden bg-surface border-border hover:border-primary/50 hover:shadow-lg hover:-translate-y-1">
                            
                            @if (day.selectedFood) {
                                <div class="absolute top-0 right-0 w-full h-1 bg-primary"></div>
                            }

                            <div class="flex flex-col items-center justify-center flex-1 pt-2">
                                <span class="text-[11px] font-medium text-text-muted mb-0.5">{{ day.dayName }}</span>
                                <span class="text-2xl font-black text-text-main group-hover:text-primary transition-colors">{{ day.dayNumber }}</span>
                                <span class="text-[10px] text-text-muted/80">{{ day.monthName }}</span>
                            </div>

                            <div class="h-10 w-full mt-auto flex items-center justify-center border-t border-border/40 bg-background/50 transition-colors group-hover:bg-primary/5 px-2">
                                @if (!day.selectedFood) {
                                    <div class="flex items-center gap-1.5 text-primary text-[10px] font-bold opacity-80 group-hover:opacity-100 group-hover:scale-105 transition-all">
                                        <icon name="plus-circle" className="w-3.5 h-3.5"></icon>
                                        <span>انتخاب غذا</span>
                                    </div>
                                } 
                                @if (day.selectedFood) {
                                    <div class="flex items-center justify-center w-full gap-1">
                                        @if (day.quantity && day.quantity > 1) {
                                            <span class="bg-primary text-white text-[9px] px-1.5 py-0.5 rounded-md font-bold">{{ day.quantity }}x</span>
                                        }
                                        <span class="text-[10px] font-bold text-primary truncate max-w-[80%]">{{ day.selectedFood }}</span>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    </div>
</div>