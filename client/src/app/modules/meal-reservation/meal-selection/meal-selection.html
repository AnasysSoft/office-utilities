<div class="flex flex-col gap-4 animate-fade-in h-full pb-2 md:pb-0">
    
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 shrink-0 mb-1">
        <div>
            <h2 class="text-xl font-bold text-text-main flex items-center gap-2">
                <div class="p-2 bg-primary/10 rounded-lg">
                    <icon name="calendar-days" className="w-6 h-6 text-primary"></icon>
                </div>
                <span>برنامه غذایی</span>
            </h2>
            <p class="text-xs text-text-muted mt-1 opacity-80 hidden md:block mr-12">برنامه ۴ هفته آینده را مدیریت کنید</p>
        </div>
        
        <div class="flex flex-wrap items-center gap-3 text-[10px] sm:text-xs bg-surface border border-border/60 px-4 py-2.5 rounded-xl shadow-sm">
            <div class="flex items-center gap-1.5">
                <span class="w-2 h-2 rounded-full bg-primary ring-2 ring-primary/20"></span>
                <span class="text-text-muted font-medium">رزرو شده</span>
            </div>
            <div class="flex items-center gap-1.5">
                <span class="w-2 h-2 rounded-full bg-primary/20"></span>
                <span class="text-text-muted font-medium">قابل انتخاب</span>
            </div>
            <div class="flex items-center gap-1.5">
                <span class="w-2 h-2 rounded-full bg-accent/20 border border-accent/40"></span>
                <span class="text-text-muted font-medium">تعطیل</span>
            </div>
        </div>
    </div>

    <div class="flex items-center justify-between bg-surface p-2 rounded-2xl shadow-sm border border-border/50 md:hidden shrink-0">
        <button (click)="prevWeek()" 
                [disabled]="currentWeekIndex === 0"
                class="p-2.5 rounded-xl bg-background border border-border/50 text-primary disabled:text-text-muted disabled:opacity-40 transition-all active:scale-90 cursor-pointer shadow-sm">
            <icon name="chevron-right" className="w-5 h-5"></icon>
        </button>

        <div class="flex flex-col items-center">
            <span class="text-sm font-black text-text-main">{{ weeks[currentWeekIndex]?.label }}</span>
            <span class="text-[10px] text-text-muted font-medium bg-gray-100 px-2 py-0.5 rounded-full mt-1">
                هفته {{ currentWeekIndex + 1 }}
            </span>
        </div>

        <button (click)="nextWeek()" 
                [disabled]="currentWeekIndex === weeks.length - 1"
                class="p-2.5 rounded-xl bg-background border border-border/50 text-primary disabled:text-text-muted disabled:opacity-40 transition-all active:scale-90 cursor-pointer shadow-sm">
            <icon name="chevron-left" className="w-5 h-5"></icon>
        </button>
    </div>

    <div class="flex-1 flex flex-col gap-2 min-h-0 overflow-y-auto md:overflow-hidden pb-2 md:pb-0">
        
        @for (week of weeks; track week.id; let wIndex = $index) {
            <div class="flex-col gap-2 transition-all duration-500 ease-in-out md:h-full"
                 [ngClass]="{
                    'hidden md:flex md:flex-1': currentWeekIndex !== wIndex, 
                    'flex h-full': currentWeekIndex === wIndex 
                 }">
                
                <div class="hidden md:flex items-center gap-3 shrink-0">
                    <div class="bg-text-main text-white text-[11px] font-bold px-3 py-1 rounded-lg shadow-md tracking-wide">
                        {{ week.label }}
                    </div>
                    <div class="h-px flex-1 bg-gradient-to-l from-transparent via-border to-transparent"></div>
                </div>

                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-7 gap-2 md:h-full">
                    
                    @for (day of week.days; track day.dateIso; let dIndex = $index) {
                        <div (click)="onSelectDay(day)"
                             class="relative flex flex-col rounded-2xl border transition-all duration-200 group overflow-hidden"
                             [ngClass]="{
                                'h-36 md:h-full': true,  

                                'bg-surface hover:border-primary/60 hover:shadow-lg hover:-translate-y-1 cursor-pointer border-border': !day.isHoliday && !day.isPast && !day.selectedFood && !day.isToday,

                                'bg-surface border-primary ring-1 ring-primary shadow-md cursor-pointer': day.selectedFood && !day.isPast && !day.isToday,
                                
                                'bg-accent/5 border-dashed border-accent/20 cursor-not-allowed': day.isHoliday && !day.isPast && !day.isToday,
                                
                                'bg-gray-100 border-transparent cursor-not-allowed opacity-60 grayscale': day.isPast,

                                'border-2 border-accent z-10 bg-surface': day.isToday
                             }">

                            @if (day.isToday) {
                                <div class="absolute -top-px -right-px bg-accent text-white text-[10px] font-bold px-3 py-1 rounded-bl-xl rounded-tr-lg shadow-sm z-20">
                                    امروز
                                </div>
                            }

                            <div class="flex flex-col items-center justify-center pt-2 pb-1 flex-1 relative min-h-0">
                                <span class="text-[11px] font-bold mb-0.5 z-10" 
                                      [ngClass]="{
                                        'text-text-muted/60': day.isPast,
                                        'text-accent': day.isHoliday && !day.isPast,
                                        'text-text-muted': !day.isHoliday && !day.isPast
                                      }">
                                    {{ day.dayName }}
                                </span>
                                
                                <span class="text-2xl xl:text-3xl font-black transition-transform duration-300 z-10"
                                      [ngClass]="{
                                        'text-text-muted/40': day.isPast,
                                        'text-accent opacity-80': day.isHoliday && !day.isPast,
                                        'text-text-main group-hover:scale-110 group-hover:text-primary': !day.isHoliday && !day.isPast
                                      }">
                                    {{ day.dayNumber }}
                                </span>
                                
                                <span class="text-[10px] font-medium z-10" [ngClass]="day.isPast ? 'text-text-muted/60' : 'text-text-muted/80'">
                                    {{ day.monthName }}
                                </span>
                            </div>

                            <div class="h-[44px] xl:h-[50px] shrink-0 w-full mt-auto flex items-center justify-center border-t transition-colors duration-300 px-2 text-center relative overflow-hidden"
                                 [ngClass]="{
                                    'border-border/30 bg-primary/5 group-hover:bg-primary group-hover:border-primary': !day.selectedFood && !day.isHoliday && !day.isPast,
                                    'bg-primary/10 border-primary/20': day.selectedFood && !day.isPast,
                                    'border-accent/10 bg-accent/5': day.isHoliday && !day.isPast,
                                    'border-transparent bg-transparent': day.isPast
                                 }">

                                @if (day.isPast) {
                                    <div class="text-[10px] text-text-muted/40 font-bold">پایان یافته</div>
                                }

                                @if (!day.isPast && !day.selectedFood && !day.isHoliday) {
                                    <div class="w-full flex items-center justify-center gap-2 group/btn cursor-pointer">
                                        <span class="text-primary text-xs font-bold group-hover:text-white transition-colors">رزرو غذا</span>
                                        <div class="bg-primary/10 p-1 rounded-full group-hover:bg-white/20 transition-colors hidden xl:block">
                                            <icon name="plus" className="w-3 h-3 text-primary group-hover:text-white"></icon>
                                        </div>
                                    </div>
                                }

                                @if (!day.isPast && day.selectedFood) {
                                    <div class="flex flex-col items-center justify-center w-full h-full gap-0.5 relative">
                                        
                                        @if (day.quantity && day.quantity > 1) {
                                            <div class="absolute top-1 left-1 bg-white/90 text-primary border border-primary/20 text-[9px] font-bold px-1.5 py-0.5 rounded-md shadow-sm z-20 flex items-center gap-0.5 animate-bounce-small">
                                                <span>{{ day.quantity }}</span>
                                                <span class="text-[8px] opacity-80 font-normal">x</span>
                                            </div>
                                        }

                                        <span class="text-[9px] text-text-muted/70 font-medium hidden xl:block">غذای انتخابی:</span>
                                        <span class="text-[10px] sm:text-xs font-bold text-primary leading-tight line-clamp-1 w-full px-1">
                                            {{ day.selectedFood }}
                                        </span>
                                    </div>
                                }

                                @if (!day.isPast && day.isHoliday) {
                                    <div class="text-[10px] text-accent font-bold">تعطیل رسمی</div>
                                }
                            </div>

                        </div>
                    }
                </div>
            </div>
        }
    </div>
</div>